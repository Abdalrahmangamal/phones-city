import { useState, useEffect } from "react";
import { useTranslation } from "react-i18next";
import { useLangSync } from "@/hooks/useLangSync";
import { useAboutStore } from "@/store/aboutusStore";
import axios from "axios";

const baseUrl = import.meta.env.VITE_BASE_URL;

export default function Contactform() {
  const { t } = useTranslation();
  const { lang } = useLangSync();
  const { data: aboutData, fetchAbout, loading: aboutLoading } = useAboutStore();

  useEffect(() => {
    fetchAbout(lang);
  }, [lang, fetchAbout]);

  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phone: "",
    message: "",
  });

  const [loading, setLoading] = useState(false);
  const [successMessage, setSuccessMessage] = useState("");
  const [errorMessage, setErrorMessage] = useState("");

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: value,
    }));
    // Clear messages when user starts typing
    if (successMessage) setSuccessMessage("");
    if (errorMessage) setErrorMessage("");
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setLoading(true);
    setSuccessMessage("");
    setErrorMessage("");

    try {
      const response = await axios.post(
        `${baseUrl}api/v1/tickets`,
        {
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          message: formData.message,
        },
        {
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
        }
      );

      setSuccessMessage("تم إرسال التذكرة بنجاح!");

      // Reset form
      setFormData({
        name: "",
        email: "",
        phone: "",
        message: "",
      });
    } catch (error: any) {
      console.error("Error submitting ticket");
      setErrorMessage(
        error?.response?.data?.message || "حدث خطأ أثناء إرسال التذكرة. يرجى المحاولة مرة أخرى."
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <div
      className="w-full bg-white py-10 md:p-4 h-full md:px-16 font-sans lg:px-[90px] px-2 pt-20 md:pt-0"
      dir={lang === "ar" ? "rtl" : "ltr"}
    >
      {/* العنوان */}
      <h2 className="text-[#211C4D] my-9 mx-[30px] md:mx-0 text-[40px] font-[700] mb-8 relative w-fit">
        {t("SendNote")}
      </h2>

      {/* المحتوى */}
      <div className="flex flex-col justify-between md:flex-row gap-[80px]">
        {/* نموذج التواصل */}
        <form onSubmit={handleSubmit} className="bg-white md:w-[800px] p-[40px]  h-[450px] rounded-xl shadow-[0px_1px_13px_0px_rgba(0,0,0,0.05)]">
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
            <input
              type="text"
              name="name"
              value={formData.name}
              onChange={handleChange}
              placeholder={t("Name")}
              className="border-none h-[50px] bg-[#F5F5F5] rounded-[4px] p-3 transition-all duration-300 ease-in-out focus:bg-white focus:ring-2 focus:ring-[#211C4D] hover:scale-[1.02]"
              required
            />
            <input
              type="email"
              name="email"
              value={formData.email}
              onChange={handleChange}
              placeholder={t("Email")}
              className="border-none h-[50px] bg-[#F5F5F5] rounded-[4px] p-3 transition-all duration-300 ease-in-out focus:bg-white focus:ring-2 focus:ring-[#211C4D] hover:scale-[1.02]"
              required
            />
            <input
              type="text"
              name="phone"
              value={formData.phone}
              onChange={handleChange}
              placeholder={t("PhoneNumber")}
              className="border-none h-[50px] col-span-2 md:col-span-1 bg-[#F5F5F5] rounded-[4px] p-3 transition-all duration-300 ease-in-out focus:bg-white focus:ring-2 focus:ring-[#211C4D] hover:scale-[1.02]"
              required
            />
          </div>

          <textarea
            name="message"
            value={formData.message}
            onChange={handleChange}
            placeholder={t("YourMessage")}
            className="border-none h-[200px] w-full bg-[#F5F5F5] rounded-[4px] p-3 transition-all duration-300 ease-in-out focus:bg-white focus:ring-2 focus:ring-[#211C4D] hover:scale-[1.01]"
            required
          ></textarea>

          {/* Success/Error Messages */}
          {successMessage && (
            <div className="mt-4 p-3 bg-green-100 text-green-700 rounded-lg text-sm">
              {successMessage}
            </div>
          )}
          {errorMessage && (
            <div className="mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
              {errorMessage}
            </div>
          )}

          <button
            type="submit"
            disabled={loading}
            className="bg-[#F3AC5D] mt-[30px] w-[136px] h-[56px] text-white px-6 py-2 rounded-[16px] transition-all duration-300 ease-in-out hover:bg-[#e29b4a] hover:scale-[1.05] focus:ring-4 focus:ring-[#F3AC5D]/50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? "جاري الإرسال..." : t("Submit")}
          </button>
        </form>

        {/* بيانات التواصل */}
        <div className="bg-white p-9 md:w-[35%] w-full rounded-xl shadow-[0px_1px_13px_0px_rgba(0,0,0,0.05)]">
          <div className="flex mt-[20px] items-center gap-3 mb-4">
            <svg
              width="40"
              height="40"
              viewBox="0 0 40 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect width="40" height="40" rx="20" fill="#F3AC5D" />
              <path
                d="M18.5542 14.241L15.1712 10.336C14.7812 9.88601 14.0662 9.88801 13.6132 10.342L10.8312 13.129C10.0032 13.958 9.76623 15.189 10.2452 16.176C13.1069 22.101 17.8853 26.8861 23.8062 29.756C24.7922 30.235 26.0222 29.998 26.8502 29.169L29.6582 26.356C30.1132 25.901 30.1142 25.182 29.6602 24.792L25.7402 21.427C25.3302 21.075 24.6932 21.121 24.2822 21.533L22.9182 22.899C22.8484 22.9722 22.7565 23.0204 22.6566 23.0363C22.5567 23.0522 22.4543 23.0349 22.3652 22.987C20.1357 21.7031 18.2862 19.8512 17.0052 17.62C16.9573 17.5308 16.9399 17.4282 16.9558 17.3282C16.9717 17.2281 17.02 17.136 17.0932 17.066L18.4532 15.705C18.8652 15.291 18.9102 14.651 18.5542 14.24V14.241Z"
                stroke="white"
                strokeWidth="1.5"
                strokeLinecap="round"
                strokeLinejoin="round"
              />
            </svg>

            <h3 className="font-[500] text-[#000000] text-[24px]">
              {t("Contactinformation")}
            </h3>
          </div>
          <p className="text-[#000000] font-[400] mt-[30px] text-[16px] mb-2">
            {t("Weareavailable24hoursaday7daysaweek")}
          </p>
          <p className="text-[#000000] font-[400] text-[16px] mb-4">
            {t("PhoneNumber")}: {aboutLoading ? "جاري التحميل..." : aboutData?.phone || "+966501108846"}
          </p>
          <hr className="h-[1px] my-[35px] bg-black text-black" />
          <div className="flex items-center gap-3 mb-2">
            <svg
              width="40"
              height="40"
              viewBox="0 0 40 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect width="40" height="40" rx="20" fill="#F3AC5D" />
              <path
                d="M10 13L20 20L30 13M10 27H30V13H10V27Z"
                stroke="white"
                strokeWidth="1.5"
                strokeLinecap="round"
                strokeLinejoin="round"
              />
            </svg>

            <h3 className="font-[500] text-[black] text-[24px]">
              {t("Sendtothephonecity")}
            </h3>
          </div>
          <p className="text-black font-[400] mt-[30px] text-[16px] mb-1">
            {t("Fillouttheformandwewillcontactyouwithin24hours")}
          </p>
          <div className="flex items-center gap-2 mt-[20px]">
            <p className="text-black font-[400] text-[16px]">
              {t("Email")}:
            </p>
            <p className="text-black font-[400] text-[16px]">
              {aboutLoading ? "جاري التحميل..." : aboutData?.email || "Support@cityphonesa.com"}
            </p>
          </div>

          {/* WhatsApp Section */}
          <hr className="h-[1px] my-[35px] bg-black text-black" />
          <div className="flex items-center gap-3 mb-4">
            <svg
              width="40"
              height="40"
              viewBox="0 0 40 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <rect width="40" height="40" rx="20" fill="#F3AC5D" />
              <path
                d="M20 10C14.48 10 10 14.48 10 20C10 21.85 10.5 23.55 11.36 25.02L10.05 29.95L15.12 28.67C16.55 29.45 18.22 29.9 20 29.9C25.52 29.9 30 25.42 30 19.9C30 14.48 25.52 10 20 10ZM25.9 23.95C25.68 24.55 24.75 25.07 24.1 25.2C23.65 25.28 23.05 25.35 21.15 24.55C18.75 23.55 17.2 21.1 17.08 20.92C16.95 20.75 16 19.5 16 18.2C16 16.9 16.68 16.27 16.95 15.97C17.18 15.72 17.55 15.6 17.9 15.6C18.02 15.6 18.12 15.6 18.22 15.62C18.5 15.62 18.68 15.67 18.88 16.12C19.1 16.62 19.62 17.92 19.68 18.05C19.75 18.17 19.8 18.32 19.7 18.5C19.62 18.67 19.55 18.77 19.42 18.92C19.3 19.07 19.18 19.17 19.05 19.32C18.93 19.45 18.8 19.6 18.95 19.85C19.1 20.1 19.62 20.95 20.38 21.62C21.35 22.5 22.15 22.77 22.4 22.88C22.65 22.98 22.8 22.95 22.95 22.78C23.1 22.6 23.58 22.05 23.75 21.77C23.92 21.5 24.1 21.55 24.35 21.62C24.6 21.7 25.9 22.35 26.15 22.47C26.4 22.6 26.55 22.65 26.62 22.75C26.7 22.9 26.7 23.42 25.9 23.95Z"
                fill="white"
              />
            </svg>
            <h3 className="font-[500] text-[black] text-[24px]">
              {lang === "ar" ? "واتساب" : "WhatsApp"}
            </h3>
          </div>
          <p className="text-black font-[400] mt-[10px] text-[16px] mb-4">
            {lang === "ar" ? "تواصل معنا مباشرة عبر واتساب" : "Contact us directly via WhatsApp"}
          </p>
          <a
            href={`https://wa.me/${aboutData?.phone?.replace(/\D/g, '') || '966501108846'}`}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-2 bg-[#F3AC5D] text-white px-6 py-3 rounded-[16px] font-[500] text-[16px] transition-all duration-300 ease-in-out hover:bg-[#e29b4a] hover:scale-[1.05] focus:ring-4 focus:ring-[#F3AC5D]/50"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12C2 13.85 2.5 15.55 3.36 17.02L2.05 21.95L7.12 20.67C8.55 21.45 10.22 21.9 12 21.9C17.52 21.9 22 17.42 22 11.9C22 6.48 17.52 2 12 2ZM17.9 15.95C17.68 16.55 16.75 17.07 16.1 17.2C15.65 17.28 15.05 17.35 13.15 16.55C10.75 15.55 9.2 13.1 9.08 12.92C8.95 12.75 8 11.5 8 10.2C8 8.9 8.68 8.27 8.95 7.97C9.18 7.72 9.55 7.6 9.9 7.6C10.02 7.6 10.12 7.6 10.22 7.62C10.5 7.62 10.68 7.67 10.88 8.12C11.1 8.62 11.62 9.92 11.68 10.05C11.75 10.17 11.8 10.32 11.7 10.5C11.62 10.67 11.55 10.77 11.42 10.92C11.3 11.07 11.18 11.17 11.05 11.32C10.93 11.45 10.8 11.6 10.95 11.85C11.1 12.1 11.62 12.95 12.38 13.62C13.35 14.5 14.15 14.77 14.4 14.88C14.65 14.98 14.8 14.95 14.95 14.78C15.1 14.6 15.58 14.05 15.75 13.77C15.92 13.5 16.1 13.55 16.35 13.62C16.6 13.7 17.9 14.35 18.15 14.47C18.4 14.6 18.55 14.65 18.62 14.75C18.7 14.9 18.7 15.42 17.9 15.95Z" />
            </svg>
            {lang === "ar" ? "راسلنا" : "Message Us"}
          </a>
        </div>
      </div>
    </div>
  );
}
